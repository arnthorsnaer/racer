name: Record Demo

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  record-demo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: bun install

      - name: Install recording tools
        run: |
          # Install asciinema via pip (much faster than apt-get)
          pip install asciinema

          # Install svg-term-cli for converting to SVG
          npm install -g svg-term-cli

      - name: Create recording wrapper script
        run: |
          cat > record.sh << 'EOF'
          #!/bin/bash
          set -e

          # Run the demo and ensure it stays alive long enough
          bun run demo.ts

          # Ensure we have a clean exit
          exit 0
          EOF
          chmod +x record.sh

      - name: Record demo with asciinema
        run: |
          # Set terminal size for readable output
          export COLUMNS=80
          export LINES=24

          # Record the demo to asciinema format
          echo "Recording demo with asciinema..."
          asciinema rec demo.cast \
            --overwrite \
            --command "./record.sh" \
            --cols 80 \
            --rows 24

          echo "Asciinema recording complete"
          ls -lh demo.cast
        timeout-minutes: 1

      - name: Convert to SVG
        run: |
          # Convert asciinema recording to SVG
          echo "Converting to SVG..."
          cat demo.cast | svg-term --out demo.svg --window --width 80 --height 24

          echo "Conversion complete"
          ls -lh demo.svg
        timeout-minutes: 1

      - name: Verify demo.svg was created
        run: |
          if [ -f demo.svg ]; then
            echo "‚úÖ Demo recording created successfully"
            ls -lh demo.svg
          else
            echo "‚ùå Failed to create demo.svg"
            exit 1
          fi

      - name: Commit demo.svg to PR branch
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Verify we're on the right branch
          git branch --show-current

          git add demo.svg
          git commit -m "Update demo.svg recording [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.head_ref }}

      - name: Upload demo artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: demo-recording
          path: demo.svg
          retention-days: 30

      - name: Comment on PR with inline demo
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const sha = context.sha;
            const branch = context.payload.pull_request.head.ref;

            // Construct the raw URL for the SVG file
            const svgUrl = `https://raw.githubusercontent.com/${repo.owner}/${repo.repo}/${branch}/demo.svg`;

            const comment = `## üé¨ Demo Recording

            ![Racer Demo](${svgUrl})

            ---

            <details>
            <summary>üìñ About this demo</summary>

            This animated terminal recording shows the Racer typing game interface.
            The demo is automatically generated on every PR update.

            **üîó Quick Links:**
            - [View demo.svg file](https://github.com/${repo.owner}/${repo.repo}/blob/${branch}/demo.svg)
            - [Download raw SVG](${svgUrl})
            - [View this commit](https://github.com/${repo.owner}/${repo.repo}/commit/${sha})

            **‚ÑπÔ∏è Note:** If the image doesn't load immediately, refresh the page or click the raw SVG link above.

            </details>

            *Automatically generated by the [Record Demo workflow](https://github.com/${repo.owner}/${repo.repo}/actions/workflows/record-demo.yml)*`;

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

