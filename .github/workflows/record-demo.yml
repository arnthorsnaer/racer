name: Record Demo

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  record-demo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: bun install

      - name: Install recording tools
        run: |
          # Install asciinema via pip (much faster than apt-get)
          pip install asciinema

          # Download agg (asciinema gif generator) pre-built binary
          # This creates animated GIFs that work everywhere
          curl -L https://github.com/asciinema/agg/releases/latest/download/agg-x86_64-unknown-linux-gnu -o /tmp/agg
          chmod +x /tmp/agg
          sudo mv /tmp/agg /usr/local/bin/agg

      - name: Create recording wrapper script
        run: |
          cat > record.sh << 'EOF'
          #!/bin/bash
          set -e

          # Run the demo and ensure it stays alive long enough
          bun run demo/index.ts

          # Ensure we have a clean exit
          exit 0
          EOF
          chmod +x record.sh

      - name: Record demo with asciinema
        run: |
          # Set terminal size for readable output
          export COLUMNS=80
          export LINES=24

          # Record the demo to asciinema format
          echo "Recording demo with asciinema..."
          asciinema rec demo.cast \
            --overwrite \
            --command "./record.sh" \
            --cols 80 \
            --rows 24

          echo "Asciinema recording complete"
          ls -lh demo.cast
        timeout-minutes: 1

      - name: Convert to animated GIF
        run: |
          # Convert asciinema recording to animated GIF
          echo "Converting to animated GIF..."
          agg demo.cast demo.gif --cols 80 --rows 24

          echo "Conversion complete"
          ls -lh demo.gif
        timeout-minutes: 1

      - name: Verify demo.gif was created
        run: |
          if [ -f demo.gif ]; then
            echo "‚úÖ Demo recording created successfully"
            ls -lh demo.gif
          else
            echo "‚ùå Failed to create demo.gif"
            exit 1
          fi

      - name: Commit demo.gif to PR branch
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Verify we're on the right branch
          git branch --show-current

          git add demo.gif
          git commit -m "Update demo.gif recording [skip ci]" || echo "No changes to commit"
          git push origin HEAD:${{ github.head_ref }}

      - name: Upload demo artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: demo-recording
          path: demo.gif
          retention-days: 30

      - name: Comment on PR with inline demo
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;
            const sha = context.sha;
            const branch = context.payload.pull_request.head.ref;

            // Construct the raw URL for the GIF file
            const gifUrl = `https://raw.githubusercontent.com/${repo.owner}/${repo.repo}/${branch}/demo.gif`;

            const comment = `## üé¨ Demo Recording

            ![Racer Demo](${gifUrl})

            ---

            <details>
            <summary>üìñ About this demo</summary>

            This animated GIF shows the Racer typing game interface in action.
            The demo is automatically generated on every PR update.

            **üîó Quick Links:**
            - [View demo.gif file](https://github.com/${repo.owner}/${repo.repo}/blob/${branch}/demo.gif)
            - [Download GIF](${gifUrl})
            - [View this commit](https://github.com/${repo.owner}/${repo.repo}/commit/${sha})

            **‚ÑπÔ∏è Note:** GIFs animate automatically in GitHub - no clicking required!

            </details>

            *Automatically generated by the [Record Demo workflow](https://github.com/${repo.owner}/${repo.repo}/actions/workflows/record-demo.yml)*`;

            await github.rest.issues.createComment({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

